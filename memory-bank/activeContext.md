# Active Context

## Current Work Focus
- Updated `partner-backend/partner-frontend/src/components/AddOfferForm.tsx` to remove manual amenity selection and automatically apply 5 random amenities to new offers.

## Recent Changes
- **Partner Offer Dashboard - Automatic Random Amenities (AddOfferForm.tsx):**
    - Modified `partner-backend/partner-frontend/src/components/AddOfferForm.tsx` to remove the manual amenity selection checkboxes.
    - Implemented logic in `handleSubmit` to automatically select 5 random amenities from `PREDEFINED_AMENITIES` and include them in the submitted offer data.
    - Removed the `selectedAmenities` state and related functions (`handleAmenityChange`, `setSelectedAmenities`).
- **Partner Offer Dashboard - Preserve Form Data in AddOfferForm (AddOfferForm.tsx):**
    - Modified `partner-backend/partner-frontend/src/components/AddOfferForm.tsx` to use a functional update for `setFormData` within the `useEffect` hook that triggers on lounge location or offer preset changes.
    - This prevents manually entered data (e.g., "Offer Title", "Bank Name", "Description") from being cleared when these dropdowns are changed.
- **Backend Data Restructuring - Centralized Partner and Offer Data:**
    - Created `partner-backend/structured-data.json` to store partner and their associated offers in a nested structure. This replaces the previous `partner-backend/initial-lounge-data.json` which was a flat list of offers.
    - Modified `partner-backend/server.ts`:
        - Updated to load initial data from `structured-data.json`.
        - Redefined internal data structures (`PartnerWithOffers`, `OfferInPartner`, `FlatOffer`) to manage the nested data.
        - The main in-memory store is now `structuredDataStore`.
        - Adapted the `/api/partners` GET endpoint to extract and serve partner information from `structuredDataStore`.
        - Adapted the `/api/offers` GET endpoint to flatten offers from `structuredDataStore` and serve them, maintaining compatibility with the frontend's expected offer structure.
        - Updated the `/api/integrate-partner` POST endpoint to add new partners to the `structuredDataStore`.
        - Updated the `/api/partners/:partnerId/offers` POST endpoint to add new offers to the appropriate partner within `structuredDataStore`.
- **Partner Offer Dashboard - Partner Logo Path Fix (ViewPartners.tsx):**
    - Modified `partner-backend/partner-frontend/src/components/ViewPartners.tsx` to ensure the `partner.logo` URL is correctly constructed with the `/images/` prefix after the `imageBaseUrl`. This resolves an issue where partner logos in the main list were missing this path segment.
- **Partner Offer Dashboard - Display Bank Logos in Partner List (ViewPartners.tsx):**
    - Modified `partner-backend/partner-frontend/src/components/ViewPartners.tsx` to display the bank logo next to each partner name in the main integrated partners list.
        - The `bankLogo` is fetched from the first offer of the partner.
        - An `<img>` tag with class `partner-list-logo` was added.
        - `imageBaseUrl` was defined in the component for constructing image URLs.
    - Added CSS for `.partner-list-logo` to `partner-backend/partner-frontend/src/index.css` to style the displayed logos (max-height, object-fit, etc.).
- **Partner Offer Dashboard - Image Path Correction (OfferCardView.tsx):**
    - Modified `partner-backend/partner-frontend/src/components/OfferCardView.tsx` to ensure all image `src` attributes (for `offer.bankLogo`, `offer.image`, and images in `offer.images[]`) are correctly prefixed with `/images/` after the `imageBaseUrl`. This aligns with the backend's static serving route for images.
- **Partner Offer Dashboard - Offer Detail View Rework (ViewPartners.tsx & New OfferCardView.tsx):**
    - Created `partner-backend/partner-frontend/src/components/OfferCardView.tsx` to render individual offer details in a card format.
    - Added CSS styles to `partner-backend/partner-frontend/src/index.css` for:
        - The `OfferCardView` component (`.offer-card-view`, `.offer-card-header`, etc.).
        - A two-column layout (`.view-partners-layout`, `.view-partners-list-column`, `.view-partners-detail-column`).
        - A list for offers of a selected partner (`.partner-offers-list`, `.partner-offers-list-item`).
    - Modified `partner-backend/partner-frontend/src/components/ViewPartners.tsx`:
        - Imported `OfferCardView`.
        - Added state `selectedOfferForCardView` to manage which offer's details are shown in the card.
        - When a partner is selected, the view now splits into two columns:
            - Left: Lists offers for the selected partner. Clicking an offer updates `selectedOfferForCardView`.
            - Right: Displays the `OfferCardView` for the `selectedOfferForCardView`.
        - Added a "Back to All Partners" button to return to the main partner list.
        - Exported `Offer` and `Amenity` interfaces and fixed type issues in `OfferCardView.tsx`.
- **Partner Offer Dashboard - UI Modernization (ViewPartners.tsx - List Styling):**
    - Added new CSS classes to `partner-backend/partner-frontend/src/index.css` for:
        - Modern button styling (`.btn-modern`, `.btn-primary`).
        - Improved partner list item styling (`.partner-list-item`, `.partner-name`, `.selected`).
    - Updated `partner-backend/partner-frontend/src/components/ViewPartners.tsx`:
        - Applied the new CSS classes to buttons and the main partner list items.
        - Removed previous inline styles for these elements.
        - Changed partner list to display `bankName` (if available) instead of just `partnerId` for better readability.
- **Partner Offer Dashboard - Automatic Data Fetching:**
    - Modified `partner-backend/partner-frontend/src/components/ViewPartners.tsx`:
        - Removed the "Load Partners & Offers" button.
        - Implemented `useEffect` to call `fetchOffers` when the component mounts, so data is loaded automatically.
        - Updated the "no partners found" message and added a loading indicator.
- **Partner Offer Dashboard UI Improvement (View Full Data):**
    - Modified `partner-backend/partner-frontend/src/components/ViewPartners.tsx` to display offer details within the `<details>` summary in a tabular format instead of a JSON string.
    - Added CSS styles to `partner-backend/partner-frontend/src/index.css` for the `.offer-details-table` class to improve readability of the new table.
    - Committed and pushed these changes with the message "feat: Improve offer details display with tabular format".
- **Partner Offer Dashboard Conversion to React:**
    - **Project Setup:**
        - Backed up old static frontend to `partner-frontend_backup`.
        - Initialized a new Vite + React + TypeScript project in `partner-backend/partner-frontend`.
        - Installed npm dependencies for the new React project.
    - **Core React Components Created (`partner-backend/partner-frontend/src/`):**
        - `App.tsx`: Main application component, manages views (Integrate Offer, View Partners) using state.
        - `components/Sidebar.tsx`: React component for sidebar navigation.
        - `components/IntegrateOfferForm.tsx`: React component for the offer integration form.
            - Implemented state management for form fields (`useState`).
            - Handles form input changes.
            - Implemented predefined amenity selection using checkboxes.
            - Handles form submission, including `FormData` for file uploads and API calls to `/api/integrate-offer`.
            - Includes basic response message display.
        - `components/ViewPartners.tsx`: React component for viewing partners and offers.
            - Implemented state for offers, partners, loading, and errors.
            - Fetches data from `/api/offers`.
            - Groups offers by partner and displays a clickable list.
            - Displays details for a selected partner.
    - **Styling:**
        - Copied CSS from `partner-frontend_backup/style.css` to `partner-backend/partner-frontend/src/index.css`.
        - Imported `index.css` in `main.tsx` to apply global styles.
    - **Vite Configuration (`partner-backend/partner-frontend/vite.config.ts`):**
        - Configured a proxy for `/api` requests to `http://localhost:3001` to facilitate local development.
    - **Backend Server Update (`partner-backend/server.ts`):**
        - Modified Express static file serving to point to `../partner-frontend/dist` (the React app's build output).
        - Updated the fallback route (`app.get('*', ...)`) to serve `index.html` from the `dist` folder, supporting client-side routing.
- **Partner Offer Dashboard - Amenities Section Rework (Previous - in static version):**
    - **`partner-backend/partner-frontend_backup/script.js`:**
        - Added a `PREDEFINED_AMENITIES` array.
        - Implemented `populateAmenities` for checkboxes.
        - Updated form submission for selected amenities.
    - **`partner-backend/partner-frontend_backup/index.html`:**
        - Replaced old amenity inputs with `amenitiesCheckboxesContainer`.
    - **`partner-backend/partner-frontend_backup/style.css`:**
        - Added styles for the amenity checkbox grid.
- **Partner Offer Dashboard Layout Rework (Sidebar Implementation - Previous - in static version):**
    - **`partner-backend/partner-frontend_backup/index.html`:**
        - Restructured to a two-column layout.
    - **`partner-backend/partner-frontend_backup/style.css`:**
        - Added CSS for the two-column layout.
    - **`partner-backend/partner-frontend_backup/script.js`:**
        - Added SPA-like navigation logic.
- **Partner Offer Dashboard UI Update (Previous - Partner/Offer List Logic - in static version):**
    - Modified `partner-backend/partner-frontend_backup/script.js`:
        - Renamed `loadCurrentOffers` to `loadPartnersAndOffers`.
        - This function now fetches offers, groups them by `bankName` (partner), and displays a clickable list of partners.
        - Added `displayOffersForPartner` function to show offers for a selected partner.
        - Dynamically creates a div with `id="selectedPartnerOffers"` to display these offers.
    - Modified `partner-backend/partner-frontend/index.html`:
        - Changed "Current Offers" heading to "Integrated Partners".
        - Changed "Load Current Offers" button text to "Load Partners".
        - Updated placeholder text in `currentOffersContainer`.
- **Image Handling Overhaul (Previous):**
    - Moved all static image assets from `src/assets/images/` to `partner-backend/public/images/`.
    - Updated `partner-backend/server.ts` to serve static files from the `partner-backend/public/` directory, making images accessible via `/images/filename.png`.
    - Deleted original image files from `src/assets/images/` (only `.gitkeep` remains).
    - Installed `react-native-fs` and `@react-native-async-storage/async-storage` for custom caching.
    - Created `src/services/ImageCache.ts` with logic for downloading, storing, and retrieving cached images.
    - Created a new component `src/components/CachedImage.tsx` that utilizes `ImageCache.ts` to display images, providing loading and fallback states.
    - Updated `src/data/mockData.ts`:
        - Changed image-related fields in `Lounge` and `Amenity` interfaces from `ImageSourcePropType` to `string` (for URLs).
        - Removed the `resolveImagePath` function.
        - Modified `fetchLoungesFromAPI` to construct full image URLs (e.g., `https://lounge-app-536s.onrender.com/images/filename.png`) from image paths received from the API.
    - Updated `src/components/LoungeCard.tsx` and `src/screens/OfferDetailScreen.tsx` to use the new `CachedImage` component and pass string URIs for all images (dynamic and static).
    - Resolved ESLint warning for unused `Image` import in `OfferDetailScreen.tsx`.

- **Previous Backend Deployment Efforts (Still Relevant):**
    - Updated `src/data/mockData.ts` to change `API_BASE_URL` to `https://lounge-app-536s.onrender.com/api`.
    - Updated `partner-backend/package.json` to downgrade Express from `^5.1.0` to `^4.19.2` and `@types/express` from `^5.0.2` to `^4.17.21`.
    - Updated `render.yaml` to specify `NODE_VERSION: 20`.
    - Previously: Updated `render.yaml` buildCommand for `partner-backend`.
    - Previously: Updated `partner-backend/tsconfig.json` with `"types": ["node"]`.

- **Previous Frontend UI/UX Changes (Context):**
    - Refactored `src/screens/ExploreScreen.tsx` layout (blue top section, grey background, white card).
    - Corrected various image loading issues and updated `LoungeCard.tsx` styles.
    - Expanded `mockData.ts` (now superseded by API fetching for image paths).
    - Implemented lounge list filtering in `ExploreScreen.tsx`.
    - Configured consistent screen transition animations.
    - Updated icons and image displays in `OfferDetailScreen.tsx` and `ExploreScreen.tsx`.
    - Resolved "Image path not found" errors by correcting paths in `partner-backend/initial-lounge-data.json`.

## Next Steps
- **Crucial:** User to ensure the `partner-backend` is running correctly (locally or deployed at `https://lounge-app-536s.onrender.com`) so that images can be served via the new URLs. The previous Render deployment issues need to be confirmed as resolved.
- User to run `npx pod-install` (or `cd ios && pod install && cd ..`) to link the new native dependencies (`react-native-fs`, `@react-native-async-storage/async-storage`) for iOS.
- Thoroughly test image loading and caching functionality across the app (e.g., in `LoungeCard` and `OfferDetailScreen`). Verify images load from the backend and are subsequently served from the local cache.
- Update `memory-bank/progress.md` to reflect the image handling changes and new dependencies.
- Update `memory-bank/systemPatterns.md` to document the new React-based architecture for the partner dashboard.
- Update `memory-bank/techContext.md` to include React, Vite, and related dependencies for the partner frontend.
- Update `.clinerules` with insights from the React conversion process.
- If `partner-backend` deployment on Render is still failing, analyze new error messages and address them. This is critical for the remote image URLs to work and for the partner dashboard to fetch offer data.
- **Next:**
    1.  **Backend Image Path Fix:** Corrected `partner-backend/server.ts` to store plain image filenames for offers added via the partner dashboard, preventing duplicated `/images/` segments in URLs.
    2.  Build the new React partner dashboard (`cd partner-backend/partner-frontend && npm run build`).
    3.  Run the backend server (`cd partner-backend && npm start` or similar).
    4.  Thoroughly test the new React-based Partner Offer Dashboard by accessing `http://localhost:3001`. This includes:
        - Verifying the fix in `AddOfferForm.tsx`: Ensure that manually entered fields (like Offer Title, Bank Name, Description) are preserved when changing "Select Lounge Location" or "Select Offer Configuration".
        - Verifying the new amenity handling in `AddOfferForm.tsx`: Confirm that the UI for manual amenity selection is removed and that new offers are submitted with 5 automatically assigned random amenities.
        - Paying special attention to the new tabular display in "View Full Data".
        - Verifying that new offers created have correctly formed image URLs when fetched by the client.
- (Previous Frontend Next Steps - to be revisited after backend deployment and image caching are verified):
    - Verify UI/UX of `ExploreScreen.tsx` (airport search, filter dropdown).
    - Test search and filter functionalities.
    - Continue replacing placeholder icons and refining styling.
- Update `memory-bank/progress.md` to reflect all recent changes to `ViewPartners.tsx` and the new `OfferCardView.tsx`.

## Active Decisions and Considerations
- **Custom Image Caching:** A custom image caching solution was implemented using `react-native-fs` and `@react-native-async-storage/async-storage`. This was chosen due to `react-native-fast-image` having peer dependency conflicts with the project's React 19 version.
- Memory Bank files are crucial for maintaining context.
- Some placeholder icons (text-based like ℹ️, 🎫) are still used in `OfferDetailScreen.tsx`; these might need to be replaced with image assets if a consistent visual style is desired.
- The orange color for icons in text fields (`#FFA500`) in `ExploreScreen.tsx` (mentioned in previous context) still needs refinement if applicable.
- **Image URL Formation:** Previously, offers added via the partner dashboard might have had image URLs constructed incorrectly (e.g., `.../images/images/filename.png`) due to the backend prepending `/images/` to already plain filenames. This has been addressed in `partner-backend/server.ts`.
